name: Secret scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gitleaks:
    name: Run gitleaks secret scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --source . --no-banner --report-path gitleaks-report.json --config-path .gitleaks.toml

      - name: Check gitleaks report
        id: gitleaks-check
        run: |
          if [ -s gitleaks-report.json ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "GITLEAKS_FOUND=1" >> $GITHUB_ENV
            cat gitleaks-report.json
            exit 1
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if leaks found
        if: ${{ github.event_name == 'pull_request' && steps.gitleaks-check.outputs.found == 'true' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            ðŸš¨ Secret(s) detected by Gitleaks. Please remove sensitive data before merging.
            The full report is attached to the workflow logs.
