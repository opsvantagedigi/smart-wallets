name: Secret scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gitleaks:
    name: Run gitleaks secret scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --source . --no-banner --report-path gitleaks-report.json --config-path .gitleaks.toml --baseline-path .gitleaks.baseline.json

      - name: Check gitleaks report
        id: gitleaks-check
        run: |
          if [ -s gitleaks-report.json ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "GITLEAKS_FOUND=1" >> $GITHUB_ENV
            cat gitleaks-report.json
            exit 1
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

    - name: Comment on PR if leaks found
    if: ${{ github.event_name == 'pull_request' && steps.gitleaks-check.outputs.found == 'true' }}
    run: |
      # Create a friendly summary message with file, line, and rule
      echo "GITLEAKS_REPORT=$(cat gitleaks-report.json)" > gitleaks_env.txt
      python3 - <<'PY'
import json,sys
data=json.load(open('gitleaks-report.json'))
if not data:
  print('No findings to report')
  sys.exit(0)
lines=['ðŸš¨ Gitleaks detected potential secrets. This repository is a sanctuary â€” please remove sensitive data before merging.']
for f in data:
  file=f.get('file','(unknown)')
  ln=f.get('line', None)
  rule=f.get('rule','(unknown)')
  match=f.get('match', '')
  if ln:
    lines.append(f'- `{file}`:{ln} â€” rule: `{rule}` â€” match: `{match}`')
  else:
    lines.append(f'- `{file}` â€” rule: `{rule}` â€” match: `{match}`')
lines.append('\nFull report is in the workflow logs.')
print('\n'.join(lines))
PY
      # Post the comment using the GitHub REST API
      PR_NUMBER=${{ github.event.pull_request.number }}
      BODY=$(python3 - <<'PY'
import json
data=json.load(open('gitleaks-report.json'))
if not data:
  print('No findings')
  sys.exit(0)
lines=['ðŸš¨ Gitleaks detected potential secrets. This repository is a sanctuary â€” please remove sensitive data before merging.']
for f in data:
  file=f.get('file','(unknown)')
  ln=f.get('line', None)
  rule=f.get('rule','(unknown)')
  match=f.get('match','')
  if ln:
    lines.append(f'- `{file}`:{ln} â€” rule: `{rule}` â€” match: `{match}`')
  else:
    lines.append(f'- `{file}` â€” rule: `{rule}` â€” match: `{match}`')
lines.append('\nFull report is in the workflow logs.')
print('\n'.join(lines))
PY
      )
      curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -X POST -d @- "${{ github.event.pull_request.comments_url }}" <<CURL
${BODY}
CURL
